<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Máquinas | Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/general.css">
  <link rel="stylesheet" href="/css/maquinas.css">
</head>

<body>
  <nav class="admin-navbar">
    <div class="nav-container">
      <a class="nav-brand" href="/admin">
        <i class="bi bi-shield-lock"></i>Panel Admin
      </a>
      <div class="nav-menu">
        <a class="nav-link active" href="/admin/maquinas">Máquinas</a>
        <a class="nav-link" href="/admin/usuarios">Usuarios</a>
        <a class="nav-link" href="/lider">Ir a Líder</a>
        <form th:action="@{/logout}" method="post" class="nav-form">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <button type="submit" class="btn-logout">
            <i class="bi bi-box-arrow-right"></i> Salir
          </button>
        </form>
      </div>
    </div>
  </nav>

  <main class="admin-container">
    <div class="page-header">
      <h1 class="page-title">Gestión de Máquinas</h1>
    </div>

    <!-- Filtros -->
    <div class="filters-card">
      <h3 class="filters-title">
        <i class="bi bi-funnel"></i> Filtros
      </h3>
      <form class="filters-form" method="get" action="/admin/maquinas">
        <div class="filter-group">
          <label class="filter-label">Tipo</label>
          <select class="filter-select" name="tipo">
            <option th:selected="${filtroTipo == null}" value="">Todos los tipos</option>
            <option th:each="t : ${tipos}" th:value="${t}" th:text="${t}" th:selected="${filtroTipo == t}"></option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Condición</label>
          <select class="filter-select" name="cond">
            <option th:selected="${filtroCond == null}" value="">Todas las condiciones</option>
            <option th:each="c : ${condiciones}" th:value="${c}" th:text="${c}" th:selected="${filtroCond == c}">
            </option>
          </select>
        </div>
        <div class="filter-actions">
          <button type="submit" class="btn-filter">
            <i class="bi bi-search"></i> Aplicar Filtros
          </button>
          <a class="btn-clear" href="/admin/maquinas">
            <i class="bi bi-x-circle"></i> Limpiar
          </a>
        </div>
      </form>
    </div>

    <!-- Crear máquina -->
    <div class="create-card">
      <h3 class="create-title">
        <i class="bi bi-plus-circle"></i> Crear Nueva Máquina
      </h3>
      <form class="create-form" method="post" action="/admin/maquinas">
        <input type="hidden" name="page" th:value="${page != null ? page.number : 0}">
        <input type="hidden" name="size" th:value="${page != null ? page.size : 10}">
        <input type="hidden" name="tipoFilter" th:value="${filtroTipo}">
        <input type="hidden" name="condFilter" th:value="${filtroCond}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Tipo de Máquina</label>
            <select class="form-select" name="tipo" required>
              <option value="" selected disabled>Seleccione el tipo...</option>
              <option th:each="t : ${tipos}" th:value="${t}" th:text="${t}"></option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Condición</label>
            <select class="form-select" name="condicion" required>
              <option value="" selected disabled>Seleccione la condición...</option>
              <option th:each="c : ${condiciones}" th:value="${c}" th:text="${c}"></option>
            </select>
          </div>
          <div class="form-group">
            <button type="submit" class="btn-create">
              <i class="bi bi-cpu"></i> Crear Máquina
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Tarjetas de máquinas -->
    <div class="machines-grid" id="machinesGrid">
      <div th:each="m : ${maquinas}" class="machine-card" th:data-machine="${m.id}">
        <div class="machine-header">
          <div class="machine-icon">
            <i class="bi bi-cpu"></i>
          </div>
          <div class="machine-status" th:classappend="${m.condicion?.name() == 'NUEVA'} ? 'status-new' : 'status-used'">
            <span th:text="${m.condicion}">NUEVA</span>
          </div>
        </div>

        <div class="machine-content">
          <h4 class="machine-name" th:text="${m.nombre}">Torno 001</h4>
          <p class="machine-code" th:text="${m.codigo}">MQ-001</p>
          <div class="machine-type">
            <i class="bi bi-tag"></i>
            <span th:text="${m.tipo}">TORNO</span>
          </div>
        </div>

        <div class="machine-actions">
          <button class="btn-view" th:onclick="|openMachineModal(${m.id})|">
            <i class="bi bi-eye"></i> Ver Detalles
          </button>
          <form th:action="@{/admin/maquinas/{id}/eliminar(id=${m.id})}" method="post" class="delete-form">
            <input type="hidden" name="page" th:value="${page != null ? page.number : 0}">
            <input type="hidden" name="size" th:value="${page != null ? page.size : 10}">
            <input type="hidden" name="tipo" th:value="${filtroTipo}">
            <input type="hidden" name="cond" th:value="${filtroCond}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="btn-delete" onclick="return confirm('¿Eliminar esta máquina?')">
              <i class="bi bi-trash"></i>
            </button>
          </form>
        </div>
      </div>

      <!-- Estado vacío -->
      <div th:if="${maquinas == null or #lists.isEmpty(maquinas)}" class="empty-state">
        <div class="empty-icon">
          <i class="bi bi-cpu"></i>
        </div>
        <h3>No hay máquinas registradas</h3>
        <p>Comienza creando tu primera máquina usando el formulario superior.</p>
      </div>
    </div>

    <!-- Paginación -->
    <div class="pagination" th:if="${page != null and page.totalPages > 1}">
      <div class="pagination-info">
        Mostrando <span th:text="${page.number + 1}">1</span> de <span th:text="${page.totalPages}">1</span> páginas
        • <span th:text="${page.totalElements}">0</span> máquinas en total
      </div>
      <div class="pagination-controls">
        <a class="pagination-btn" th:classappend="${page.first} ? 'disabled' : ''"
          th:href="@{/admin/maquinas(page=${page.number-1}, size=${page.size}, tipo=${filtroTipo}, cond=${filtroCond})}">
          <i class="bi bi-chevron-left"></i> Anterior
        </a>
        <a class="pagination-btn" th:classappend="${page.last} ? 'disabled' : ''"
          th:href="@{/admin/maquinas(page=${page.number+1}, size=${page.size}, tipo=${filtroTipo}, cond=${filtroCond})}">
          Siguiente <i class="bi bi-chevron-right"></i>
        </a>
      </div>
    </div>
  </main>

  <!-- Modal de detalles de máquina -->
  <div id="machineModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Detalles de la Máquina</h2>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>Cargando información de la máquina...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/maquinas.js"></script>
</body>

</html>