<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Máquinas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

  <h2 class="mb-3">Máquinas</h2>
  <a th:href="@{/admin}" class="btn btn-outline-secondary mb-3">Volver al menú</a>

  <!-- ========================= FILTROS ========================= -->
  <form class="row g-2 align-items-end mb-4" th:action="@{/admin/maquinas}" method="get">
    <div class="col-md-3">
      <label class="form-label mb-1">Filtrar por tipo</label>
      <select class="form-select" name="tipo">
        <!-- OJO: cadena vacía en Thymeleaf debe ser '' (comillas simples) -->
        <option th:value="''" th:selected="${filtroTipo == null}">Todos</option>
        <option th:each="t : ${tipos}"
                th:value="${t}"
                th:text="${t}"
                th:selected="${filtroTipo != null and t == filtroTipo}">
        </option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label mb-1">Filtrar por condición</label>
      <select class="form-select" name="cond">
        <option th:value="''" th:selected="${filtroCond == null}">Todas</option>
        <option th:each="c : ${condiciones}"
                th:value="${c}"
                th:text="${c}"
                th:selected="${filtroCond != null and c == filtroCond}">
        </option>
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label mb-1">&nbsp;</label>
      <button class="btn btn-primary w-100" type="submit">Aplicar</button>
    </div>
    <div class="col-md-2">
      <label class="form-label mb-1">&nbsp;</label>
      <a class="btn btn-outline-secondary w-100" th:href="@{/admin/maquinas}">Limpiar</a>
    </div>
    <div class="col-md-2">
      <label class="form-label mb-1">&nbsp;</label>
      <a class="btn btn-success w-100"
         th:href="@{/admin/maquinas/export.csv(tipo=${filtroTipo},cond=${filtroCond})}">
        Exportar CSV
      </a>
    </div>
  </form>

  <!-- ========================= ALTA (selects) ========================= -->
  <form class="row g-2 align-items-end mb-4" th:action="@{/admin/maquinas}" method="post">
    <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

    <!-- Mantener paginación y filtros actuales al crear -->
    <input type="hidden" name="page" th:value="${page.number}"/>
    <input type="hidden" name="size" th:value="${page.size}"/>
    <input type="hidden" name="tipoFilter" th:value="${filtroTipo}"/>
    <input type="hidden" name="condFilter" th:value="${filtroCond}"/>

    <div class="col-md-4">
      <label class="form-label mb-1">Tipo de máquina</label>
      <select class="form-select" name="tipo" required>
        <option th:each="t : ${tipos}"
                th:value="${t}"
                th:text="${t}"
                th:selected="${(param.prefTipo != null and t.name() == param.prefTipo[0]) 
                               or (param.prefTipo == null and filtroTipo != null and t == filtroTipo)}">
        </option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label mb-1">Condición</label>
      <select class="form-select" name="condicion" required>
        <option th:each="c : ${condiciones}"
                th:value="${c}"
                th:text="${c}"
                th:selected="${(param.prefCond != null and c.name() == param.prefCond[0])
                               or (param.prefCond == null and filtroCond != null and c == filtroCond)}">
        </option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label mb-1">&nbsp;</label>
      <button class="btn btn-primary w-100" type="submit">Agregar</button>
    </div>
  </form>

  <!-- ========================= TABLA ========================= -->
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>#</th><th>Código</th><th>Nombre</th><th>Tipo</th><th>Condición</th><th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="m : ${maquinas}">
          <td th:text="${m.id}"></td>
          <td th:text="${m.codigo}"></td>
          <td th:text="${m.nombre}"></td>
          <td th:text="${m.tipo}"></td>
          <td th:text="${m.condicion}"></td>
          <td class="text-end">
            <!-- Duplicar (precarga selects) -->
            <form th:action="@{/admin/maquinas/{id}/duplicar(id=${m.id})}" method="post" class="d-inline">
              <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
              <input type="hidden" name="page" th:value="${page.number}">
              <input type="hidden" name="size" th:value="${page.size}">
              <input type="hidden" name="tipo" th:value="${filtroTipo}">
              <input type="hidden" name="cond" th:value="${filtroCond}">
              <button class="btn btn-sm btn-outline-primary" type="submit">Duplicar</button>
            </form>

            <!-- Eliminar -->
            <form th:action="@{/admin/maquinas/{id}/eliminar(id=${m.id})}" method="post" class="d-inline">
              <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
              <input type="hidden" name="page" th:value="${page.number}">
              <input type="hidden" name="size" th:value="${page.size}">
              <input type="hidden" name="tipo" th:value="${filtroTipo}">
              <input type="hidden" name="cond" th:value="${filtroCond}">
              <button class="btn btn-sm btn-danger" type="submit"
                      onclick="return confirm('¿Eliminar esta máquina?')">Eliminar</button>
            </form>
          </td>
        </tr>
        <tr th:if="${#lists.isEmpty(maquinas)}">
          <td colspan="6" class="text-center text-muted py-4">No hay registros</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ========================= PAGINACIÓN ========================= -->
  <nav th:if="${page.totalPages > 1}">
    <ul class="pagination">
      <li class="page-item" th:classappend="${page.first} ? 'disabled'">
        <a class="page-link"
           th:href="@{/admin/maquinas(page=${page.number - 1}, size=${page.size}, tipo=${filtroTipo}, cond=${filtroCond})}">
          «
        </a>
      </li>

      <li class="page-item"
          th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}"
          th:classappend="${i == page.number} ? 'active'">
        <a class="page-link"
           th:text="${i + 1}"
           th:href="@{/admin/maquinas(page=${i}, size=${page.size}, tipo=${filtroTipo}, cond=${filtroCond})}">
        </a>
      </li>

      <li class="page-item" th:classappend="${page.last} ? 'disabled'">
        <a class="page-link"
           th:href="@{/admin/maquinas(page=${page.number + 1}, size=${page.size}, tipo=${filtroTipo}, cond=${filtroCond})}">
          »
        </a>
      </li>
    </ul>
  </nav>

</body>
</html>
