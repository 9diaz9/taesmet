<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Usuarios | Panel Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/general.css">
  <link rel="stylesheet" href="/css/usuarios.css">
</head>

<body>

  <nav class="admin-navbar">
    <div class="nav-container">
      <a class="nav-brand" href="/admin">
        <i class="bi bi-shield-lock"></i>Panel Admin
      </a>
      <div class="nav-menu">
        <a class="nav-link" href="/admin/maquinas">Máquinas</a>
        <a class="nav-link active" href="/admin/usuarios">Usuarios</a>
        <a class="nav-link" href="/lider">Ir a Líder</a>
        <form th:action="@{/logout}" method="post" class="nav-form">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <button type="submit" class="btn-logout">
            <i class="bi bi-box-arrow-right"></i> Salir
          </button>
        </form>
      </div>
    </div>
  </nav>

  <main class="admin-container">
    <div class="page-header">
      <h1 class="page-title">Gestión de Usuarios</h1>
      <a href="/admin" class="btn-back">
        <i class="bi bi-arrow-left"></i> Panel
      </a>
    </div>

    <!-- Alertas -->
    <div th:if="${param.ok}" class="alert alert-success">
      <i class="bi bi-check-circle"></i> Operación realizada con éxito.
      <button class="alert-close">&times;</button>
    </div>
    <div th:if="${param.error}" class="alert alert-danger">
      <i class="bi bi-x-circle"></i>
      <span th:text="${param.error}">Ha ocurrido un error.</span>
      <button class="alert-close">&times;</button>
    </div>

    <div class="content-grid">
      <!-- Formulario -->
      <div class="form-section">
        <div class="form-card">
          <h2 class="form-title">
            <i class="bi bi-person-plus"></i> Crear nuevo usuario
          </h2>

          <form th:action="@{/admin/usuarios}" th:object="${usuarioForm}" method="post" id="usuarioForm"
            class="user-form">
            <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <!-- Errores globales -->
            <div class="global-errors" th:if="${#fields.hasErrors()}">
              <strong>Revisa los datos:</strong>
              <ul>
                <li th:each="err : ${#fields.errors()}" th:text="${err}"></li>
              </ul>
            </div>

            <!-- Nombre -->
            <div class="form-group">
              <label class="form-label">Nombre</label>
              <input th:field="*{nombre}" class="form-input" id="nombre" placeholder="Nombre completo" maxlength="60"
                autocomplete="off">
              <div class="error-message" id="nombreError"></div>
              <div class="form-hint">
                Solo letras y espacios; sin números ni repeticiones extrañas
              </div>
            </div>

            <!-- Email -->
            <div class="form-group">
              <label class="form-label">Email</label>
              <input th:field="*{email}" class="form-input" id="email" placeholder="nombre@taesmet.com" maxlength="64"
                autocomplete="off">
              <div class="error-message" id="emailError"></div>
              <div class="form-hint">
                Solo emails del dominio @taesmet.com
              </div>
            </div>

            <!-- Contraseña -->
            <div class="form-group">
              <label class="form-label">Contraseña</label>
              <input type="password" th:field="*{plainPassword}" class="form-input" id="password" placeholder="••••••••"
                maxlength="15">
              <div class="error-message" id="passwordError"></div>
              <div class="password-strength">
                <div class="strength-bar">
                  <div class="strength-fill" id="strengthFill"></div>
                </div>
                <span class="strength-text" id="strengthText">Seguridad</span>
              </div>
              <div class="form-hint">
                Ejemplos válidos: <code>Peru2024#</code>, <code>Nicolas#12</code>
              </div>
            </div>

            <!-- Rol -->
            <div class="form-group">
              <label class="form-label">Rol</label>
              <select th:field="*{rol}" class="form-select" id="rol">
                <option value="" disabled selected>Selecciona un rol...</option>
                <option th:each="r : ${roles}" th:value="${r}" th:text="${r}"></option>
              </select>
              <div class="error-message" id="rolError"></div>
            </div>

            <button type="submit" class="btn-submit" id="submitBtn" disabled>
              <i class="bi bi-save"></i> Crear usuario
            </button>
          </form>
        </div>
      </div>

      <!-- Tabla -->
      <div class="table-section">
        <div class="table-card">
          <div class="table-header">
            <h2 class="table-title">
              <i class="bi bi-people"></i> Usuarios registrados
            </h2>
            <span class="user-count" th:text="${#lists.size(usuarios)} + ' usuarios'">0 usuarios</span>
          </div>

          <div class="table-container">
            <table class="users-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Rol</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="u : ${usuarios}">
                  <td th:text="${u.id}">1</td>
                  <td th:text="${u.nombre}">Usuario</td>
                  <td th:text="${u.email}">correo@taesmet.com</td>
                  <td>
                    <span class="role-badge" th:text="${u.rol}" th:classappend="
                            ${u.rol?.name()=='ADMIN'} ? 'role-admin' :
                            (${u.rol?.name()=='LIDER'} ? 'role-lider' : 'role-tecnico')">
                      LIDER
                    </span>
                  </td>
                  <td class="actions">
                    <form th:action="@{/admin/usuarios/{id}/eliminar(id=${u.id})}" method="post" class="delete-form"
                      onsubmit="return confirmDelete(this)">
                      <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                      <button type="submit" class="btn-delete">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </td>
                </tr>
                <tr th:if="${#lists.isEmpty(usuarios)}">
                  <td colspan="5" class="no-users">Aún no hay usuarios</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="/js/validations_usuarios.js"></script>
  <script src="/js/usuarios.js"></script>
</body>

</html>