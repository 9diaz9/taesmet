<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mantenimientos | Panel L√≠der</title>
  <link rel="stylesheet" href="/css/mantenimiento.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>

<body>
  <!-- Navbar -->
  <nav class="admin-navbar">
    <div class="nav-container">
      <a href="/lider" class="nav-brand">
        <i class="bi bi-speedometer2"></i>
        <span>Panel de L√≠der</span>
      </a>
      <div class="nav-menu">
        <a href="/lider" class="nav-link">Inicio</a>
        <a href="/lider/maquinas" class="nav-link">M√°quinas</a>
        <a href="/lider/mantenimientos" class="nav-link active">Mantenimientos</a>
        <a href="/lider/repuestos" class="nav-link">Repuestos</a>
        <form th:action="@{/logout}" method="post" class="nav-form">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <button type="submit" class="btn-logout">
            <i class="bi bi-box-arrow-right"></i>
            <span>Salir</span>
          </button>
        </form>
      </div>
    </div>
  </nav>

  <main class="main-container">
    <!-- Header -->
    <div class="page-header">
      <h1 class="page-title">Mantenimientos</h1>
      <a href="/lider" class="btn-back">
        <i class="bi bi-arrow-left"></i>
        <span>Volver al Panel</span>
      </a>
    </div>

    <!-- Alerts -->
    <div th:if="${param.ok}" class="alert alert-success">
      <div class="alert-icon">
        <i class="bi bi-check-circle"></i>
      </div>
      <div class="alert-content">
        <p>Mantenimiento asignado correctamente.</p>
      </div>
      <button type="button" class="alert-close">&times;</button>
    </div>

    <div th:if="${param.error == 'duplicado'}" class="alert alert-warning">
      <div class="alert-icon">
        <i class="bi bi-exclamation-triangle"></i>
      </div>
      <div class="alert-content">
        <p>Ya hay un mantenimiento pendiente/en proceso del mismo tipo para esa m√°quina.</p>
      </div>
      <button type="button" class="alert-close">&times;</button>
    </div>

    <!-- Asignar Mantenimiento -->
    <div class="card assign-card">
      <div class="card-header">
        <i class="bi bi-person-gear"></i>
        <h2>Asignar mantenimiento</h2>
      </div>
      <div class="card-body">
        <form class="assign-form" method="post" action="/lider/mantenimientos/asignar">
          <!-- üîí Token CSRF obligatorio -->
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">M√°quina</label>
              <select class="form-select" name="maquinaId" required>
                <option value="" selected disabled>Seleccione una m√°quina...</option>
                <option th:each="mq : ${maquinas}" th:value="${mq.id}" th:text="${mq.codigo + ' - ' + mq.nombre}"
                  th:selected="${selMaquinaId != null and selMaquinaId == mq.id}"></option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">T√©cnico</label>
              <select class="form-select" name="tecnicoId" required>
                <option value="" selected disabled>Seleccione un t√©cnico...</option>
                <option th:each="t : ${tecnicos}" th:value="${t.id}" th:text="${t.nombre + ' (' + t.email + ')'}">
                </option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Tipo</label>
              <select class="form-select" name="tipo" required>
                <option value="" selected disabled>Seleccione tipo...</option>
                <option th:each="tm : ${tipos}" th:value="${tm}" th:text="${tm}"></option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Programado para</label>
              <input type="date" class="form-input" name="programadoPara">
            </div>
          </div>

          <div class="form-group full-width">
            <label class="form-label">Descripci√≥n (opcional)</label>
            <textarea class="form-textarea" name="descripcion" rows="2"
              placeholder="Detalle del mantenimiento..."></textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-submit">
              <i class="bi bi-save"></i>
              <span>Asignar Mantenimiento</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Lista de Mantenimientos -->
    <div class="card table-card">
      <div class="card-header">
        <h2>Lista de Mantenimientos</h2>
        <div class="table-controls">
          <div class="search-box">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Buscar mantenimientos..." id="searchInput">
          </div>
        </div>
      </div>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th data-sort="id">ID <i class="bi bi-arrow-down-up"></i></th>
              <th data-sort="maquina">M√°quina <i class="bi bi-arrow-down-up"></i></th>
              <th data-sort="tipo">Tipo <i class="bi bi-arrow-down-up"></i></th>
              <th data-sort="estado">Estado <i class="bi bi-arrow-down-up"></i></th>
              <th data-sort="tecnico">Asignado a <i class="bi bi-arrow-down-up"></i></th>
              <th data-sort="fecha">Programado <i class="bi bi-arrow-down-up"></i></th>
              <th>Descripci√≥n</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="m : ${mantenimientos}" class="table-row" th:attr="data-id=${m.id}">
              <td th:text="${m.id}">1</td>
              <td th:text="${m.maquina != null} ? ${m.maquina.codigo + ' - ' + m.maquina.nombre} : '‚Äî'">‚Äî</td>
              <td th:text="${m.tipo}">PREVENTIVO</td>
              <td>
                <span class="status-badge" th:classappend="${m.estado.name() == 'PENDIENTE'} ? 'status-pending' :
                                     (${m.estado.name() == 'EN_PROCESO'} ? 'status-in-progress' :
                                     (${m.estado.name() == 'REALIZADO'} ? 'status-completed' : 'status-waiting'))"
                  th:text="${m.estado}">PENDIENTE</span>
              </td>
              <td th:text="${m.asignadoA != null} ? ${m.asignadoA.nombre} : '‚Äî'">‚Äî</td>
              <td th:text="${m.programadoPara}">2025-01-01</td>
              <td class="description-cell">
                <span class="description-text" th:text="${m.descripcion} ?: '‚Äî'">‚Äî</span>
                <button class="btn-expand" th:if="${m.descripcion != null and m.descripcion.length() > 50}">
                  <i class="bi bi-chevron-down"></i>
                </button>
              </td>
            </tr>
            <tr th:if="${#lists.isEmpty(mantenimientos)}" class="empty-row">
              <td colspan="7">
                <div class="empty-state">
                  <i class="bi bi-inbox"></i>
                  <p>No hay mantenimientos registrados</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginaci√≥n -->
      <div class="pagination" th:if="${page != null and !page.empty}">
        <div class="pagination-info">
          <span>P√°gina <strong th:text="${page.number + 1}">1</strong> de <strong
              th:text="${page.totalPages}">1</strong></span>
          <span class="pagination-total">Total: <strong th:text="${page.totalElements}">0</strong> mantenimientos</span>
        </div>
        <div class="pagination-controls">
          <a th:href="@{/lider/mantenimientos(page=${page.number-1}, size=${page.size}, maquinaId=${selMaquinaId})}"
            th:classappend="${page.first} ? 'disabled' : ''" class="pagination-btn">
            <i class="bi bi-chevron-left"></i>
            <span>Anterior</span>
          </a>
          <a th:href="@{/lider/mantenimientos(page=${page.number+1}, size=${page.size}, maquinaId=${selMaquinaId})}"
            th:classappend="${page.last} ? 'disabled' : ''" class="pagination-btn">
            <span>Siguiente</span>
            <i class="bi bi-chevron-right"></i>
          </a>
        </div>
      </div>
    </div>
  </main>
  
  <script src="/js/mantenimiento_validation.js"></script>
  <script src="/js/mantenimiento.js"></script>
</body>

</html>