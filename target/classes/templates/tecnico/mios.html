<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mis Mantenimientos | Técnico</title>
  <link rel="stylesheet" href="/css/mios.css">
</head>

<body>
  <!-- Navbar -->
  <nav class="admin-navbar">
    <div class="nav-container">
      <a href="/tecnico" class="nav-brand">
        <i class="bi bi-tools"></i>
        <span>Panel de Técnico</span>
      </a>
      <div class="nav-menu">
        <a href="/tecnico" class="nav-link">Inicio</a>
        <a href="/tecnico/mios" class="nav-link active">Mis Mantenimientos</a>
        <a href="/tecnico/mis-solicitudes" class="nav-link">Mis Solicitudes</a>
        <form th:action="@{/logout}" method="post" class="nav-form">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <button type="submit" class="btn-logout">
            <i class="bi bi-box-arrow-right"></i>
            <span>Salir</span>
          </button>
        </form>
      </div>
    </div>
  </nav>

  <main class="main-container">
    <!-- Header -->
    <div class="page-header">
      <div class="header-content">
        <h1 class="page-title">Mis Mantenimientos</h1>
        <p class="page-subtitle">Gestiona las órdenes de trabajo asignadas a ti</p>
      </div>
      <div class="header-actions">
        <a href="/tecnico" class="btn-secondary">
          <i class="bi bi-arrow-left"></i>
          <span>Volver al Inicio</span>
        </a>
        <a href="/tecnico/crear-solicitud" class="btn-primary">
          <i class="bi bi-plus-circle"></i>
          <span>Crear Solicitud</span>
        </a>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters-card">
      <div class="filters-header">
        <i class="bi bi-funnel"></i>
        <h3>Filtros</h3>
      </div>
      <div class="filters-body">
        <div class="filter-group">
          <label for="filterEstado">Estado:</label>
          <select id="filterEstado" class="filter-select">
            <option value="">Todos los estados</option>
            <option value="PENDIENTE">Pendiente</option>
            <option value="EN_PROCESO">En Proceso</option>
            <option value="EN_ESPERA">En Espera</option>
            <option value="FALTA_REPUESTOS">Falta Repuestos</option>
            <option value="COMPLETADO">Completado</option>
            <option value="REALIZADO">Realizado</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filterTipo">Tipo:</label>
          <select id="filterTipo" class="filter-select">
            <option value="">Todos los tipos</option>
            <option value="CRITICO">Crítico</option>
            <option value="PREVENTIVO_ELECTRICO">Preventivo Eléctrico</option>
            <option value="PREVENTIVO_MECANICO">Preventivo Mecánico</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filterSearch">Buscar:</label>
          <input type="text" id="filterSearch" class="filter-input" placeholder="Buscar por máquina...">
        </div>
        <button type="button" class="btn-clear-filters" onclick="clearFilters()">
          <i class="bi bi-x-circle"></i>
          <span>Limpiar</span>
        </button>
      </div>
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="quick-stats">
      <div class="stat-item">
        <span class="stat-number" id="totalMttos" th:text="${mttos != null ? mttos.size() : 0}">0</span>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-item">
        <span class="stat-number pending" id="pendingMttos">0</span>
        <span class="stat-label">Pendientes</span>
      </div>
      <div class="stat-item">
        <span class="stat-number in-progress" id="progressMttos">0</span>
        <span class="stat-label">En Proceso</span>
      </div>
      <div class="stat-item">
        <span class="stat-number completed" id="completedMttos">0</span>
        <span class="stat-label">Completados</span>
      </div>
    </div>

    <!-- Lista de Mantenimientos -->
    <div class="mantenimientos-section">
      <div class="section-header">
        <h2 class="section-title">Lista de Mantenimientos</h2>
        <div class="section-actions">
          <button type="button" class="btn-refresh" onclick="loadMantenimientos()" title="Actualizar">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>

      <div class="mantenimientos-list" id="mantenimientosList">
        <!-- Mantenimientos cargados desde el servidor -->
        <div th:if="${mttos != null and !mttos.empty}" class="mantenimientos-container">
          <div th:each="mtto : ${mttos}" class="mantenimiento-card" th:data-estado="${mtto.estado.name()}"
            th:data-tipo="${mtto.tipo.name()}">
            <div class="mantenimiento-header">
              <div class="mantenimiento-title">
                <h3 th:text="'MT-' + ${mtto.id} + ' - ' + ${mtto.maquina?.codigo}">MT-001 - PHT-001</h3>
                <span th:classappend="'status-badge status-' + ${mtto.estado.name().toLowerCase()}"
                  th:text="${mtto.estado.name()}">PENDIENTE</span>
              </div>
              <div class="mantenimiento-actions">
                <div class="action-group">
                  <button type="button" class="btn-action btn-info" onclick="showDetails(this)" title="Ver detalles">
                    <i class="bi bi-info-circle"></i>
                  </button>
                  <button type="button" class="btn-action btn-edit" onclick="changeEstado(this)" title="Cambiar estado">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <a th:href="@{/tecnico/repuestos/solicitar/{id}(id=${mtto.id})}" class="btn-action btn-request"
                    th:if="${!solicitados.get(mtto.id)}" title="Solicitar repuesto">
                    <i class="bi bi-box-seam"></i>
                  </a>
                  <span th:if="${solicitados.get(mtto.id)}" class="solicitud-badge" title="Solicitud enviada">
                    <i class="bi bi-check-circle"></i>
                  </span>
                </div>
              </div>
            </div>

            <div class="mantenimiento-body">
              <div class="mantenimiento-details">
                <div class="detail-row">
                  <div class="detail-item">
                    <label>Máquina:</label>
                    <span th:text="${mtto.maquina?.nombre} ?: 'N/A'">Prensa Hidráulica</span>
                  </div>
                  <div class="detail-item">
                    <label>Tipo:</label>
                    <span th:text="${mtto.tipo}">PREVENTIVO</span>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-item">
                    <label>Programado:</label>
                    <span th:text="${mtto.programadoPara} ?: 'No programado'">2024-01-15</span>
                  </div>
                  <div class="detail-item">
                    <label>Asignado:</label>
                    <span th:text="${mtto.creadoEn}">2024-01-10</span>
                  </div>
                </div>
                <div class="detail-row" th:if="${mtto.descripcion}">
                  <div class="detail-item full-width">
                    <label>Descripción:</label>
                    <span th:text="${mtto.descripcion}">Mantenimiento preventivo programado</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Detalles expandibles -->
            <div class="mantenimiento-expandable">
              <div class="expandable-content">
                <div class="info-grid">
                  <div class="info-item">
                    <label>Código Máquina:</label>
                    <span th:text="${mtto.maquina?.codigo} ?: 'N/A'">PHT-001</span>
                  </div>
                  <div class="info-item">
                    <label>Tipo de Máquina:</label>
                    <span th:text="${mtto.maquina?.tipo} ?: 'N/A'">PHT</span>
                  </div>
                  <div class="info-item">
                    <label>Condición:</label>
                    <span th:text="${mtto.maquina?.condicion} ?: 'N/A'">USADA</span>
                  </div>
                  <div class="info-item">
                    <label>Fecha Creación:</label>
                    <span th:text="${mtto.creadoEn}">2024-01-10 10:30:00</span>
                  </div>
                </div>

                <!-- Acciones de estado -->
                <div class="estado-actions"
                  th:if="${mtto.estado.name() != 'COMPLETADO' and mtto.estado.name() != 'REALIZADO'}">
                  <form th:action="@{/tecnico/mttos/{id}/estado(id=${mtto.id})}" method="post" class="estado-form">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <label>Cambiar estado:</label>
                    <select name="nuevo" class="estado-select" onchange="this.form.submit()">
                      <option value="">Seleccionar...</option>
                      <option th:value="PENDIENTE" th:selected="${mtto.estado.name() == 'PENDIENTE'}">Pendiente</option>
                      <option th:value="EN_PROCESO" th:selected="${mtto.estado.name() == 'EN_PROCESO'}">En Proceso
                      </option>
                      <option th:value="EN_ESPERA" th:selected="${mtto.estado.name() == 'EN_ESPERA'}">En Espera</option>
                      <option th:value="FALTA_REPUESTOS" th:selected="${mtto.estado.name() == 'FALTA_REPUESTOS'}">Falta
                        Repuestos</option>
                      <option th:value="COMPLETADO" th:selected="${mtto.estado.name() == 'COMPLETADO'}">Completado
                      </option>
                    </select>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Estado vacío -->
        <div th:if="${mttos == null or mttos.empty}" class="empty-state">
          <div class="empty-icon">
            <i class="bi bi-inbox"></i>
          </div>
          <h3>No hay mantenimientos asignados</h3>
          <p>Actualmente no tienes órdenes de trabajo asignadas.</p>
          <div class="empty-actions">
            <a href="/tecnico" class="btn-primary">
              <i class="bi bi-house"></i>
              <span>Volver al Inicio</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="/js/mios.js"></script>
</body>

</html>